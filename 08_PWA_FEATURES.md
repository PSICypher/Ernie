# PWA Features

## Overview

The Holiday Planner App is a Progressive Web App (PWA) with:

- Installable on mobile and desktop
- Offline support with fallback page
- Push notifications for collaboration
- Service worker for caching

---

## Configuration

### next.config.js

```javascript
const withPWA = require('next-pwa')({
  dest: 'public',
  disable: process.env.NODE_ENV === 'development',
  skipWaiting: true,
  fallbacks: {
    document: '/_offline',
  },
});

module.exports = withPWA({
  experimental: {
    serverActions: true,
  },
  images: {
    domains: ['images.unsplash.com', 'maps.googleapis.com'],
  },
});
```

### manifest.json

```json
{
  "name": "Holiday Planner",
  "short_name": "Holidays",
  "description": "Plan your family holidays with AI assistance",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#8B5CF6",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "/icons/icon-72x72.png",
      "sizes": "72x72",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-96x96.png",
      "sizes": "96x96",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-128x128.png",
      "sizes": "128x128",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-144x144.png",
      "sizes": "144x144",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-152x152.png",
      "sizes": "152x152",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-384x384.png",
      "sizes": "384x384",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ]
}
```

---

## Service Worker

### Caching Strategy

| Resource Type | Strategy | Cache Duration |
|---------------|----------|----------------|
| Static assets | Cache First | 30 days |
| API responses | Network First | 7 days |
| Page navigations | Network First | 24 hours |
| Images | Cache First | 30 days |
| Fonts | Cache First | 1 year |

### Workbox Configuration

```javascript
// Generated by next-pwa
// sw.js handles:
// - Precaching static assets
// - Runtime caching
// - Offline fallback
```

---

## Offline Page

**File:** `/app/_offline/page.tsx`

This page is shown when the user is offline and tries to navigate to a page not in the cache.

```tsx
'use client';

import { WifiOff } from 'lucide-react';

export default function OfflinePage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="text-center p-8 max-w-md">
        <div className="w-16 h-16 mx-auto bg-purple-100 rounded-full flex items-center justify-center mb-6">
          <WifiOff className="w-8 h-8 text-purple-600" />
        </div>
        <h1 className="text-2xl font-bold text-gray-900 mb-2">
          You&apos;re Offline
        </h1>
        <p className="text-gray-600 mb-6">
          Check your internet connection and try again.
          Your data will sync when you&apos;re back online.
        </p>
        <button
          onClick={() => window.location.reload()}
          className="px-6 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700"
        >
          Try Again
        </button>
      </div>
    </div>
  );
}
```

**Configuration in next.config.js:**
```javascript
const withPWA = require('next-pwa')({
  dest: 'public',
  disable: process.env.NODE_ENV === 'development',
  skipWaiting: true,
  fallbacks: {
    document: '/_offline',  // This routes to the offline page
  },
});
```

---

## Push Notifications

### Setup

**Environment Variables:**
```bash
# Required for push notifications
NEXT_PUBLIC_VAPID_PUBLIC_KEY=BM...  # Public VAPID key (safe to expose)
VAPID_PRIVATE_KEY=...               # Private VAPID key (server-side only, KEEP SECRET)
VAPID_SUBJECT=mailto:admin@example.com  # Contact email for push service
```

**Generating VAPID Keys:**
```bash
# Using web-push CLI
npx web-push generate-vapid-keys

# Output:
# Public Key: BM...
# Private Key: ...
```

**Note:** These keys are REQUIRED for push notifications to work. Without them, the subscribe/notify endpoints will fail.

### Client Subscription

```typescript
// lib/push-utils.ts
export async function subscribeToPush() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
    return null;
  }

  const registration = await navigator.serviceWorker.ready;

  const subscription = await registration.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(
      process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY!
    ),
  });

  // Send subscription to server
  await fetch('/api/push/subscribe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(subscription),
  });

  return subscription;
}
```

### Server Notification

```typescript
// lib/push-utils.ts (server)
import webpush from 'web-push';

webpush.setVapidDetails(
  process.env.VAPID_SUBJECT!,
  process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY!,
  process.env.VAPID_PRIVATE_KEY!
);

export async function sendPushNotification({
  title,
  message,
  excludeUserId,
}: {
  title: string;
  message: string;
  excludeUserId?: string;
}) {
  const supabase = createAdminSupabaseClient();

  // Get all subscriptions except excluded user
  let query = supabase.from('push_subscriptions').select('*');
  if (excludeUserId) {
    query = query.neq('user_id', excludeUserId);
  }

  const { data: subscriptions } = await query;

  const payload = JSON.stringify({
    title,
    body: message,
    icon: '/icons/icon-192x192.png',
    badge: '/icons/badge-72x72.png',
  });

  const results = await Promise.allSettled(
    (subscriptions || []).map(sub =>
      webpush.sendNotification(
        {
          endpoint: sub.endpoint,
          keys: { p256dh: sub.p256dh, auth: sub.auth },
        },
        payload
      )
    )
  );

  return results.filter(r => r.status === 'fulfilled').length;
}
```

### Service Worker Handler

```javascript
// public/sw.js (handled by next-pwa)
self.addEventListener('push', function(event) {
  const data = event.data.json();

  const options = {
    body: data.body,
    icon: data.icon,
    badge: data.badge,
    vibrate: [100, 50, 100],
    data: {
      dateOfArrival: Date.now(),
      primaryKey: 1
    }
  };

  event.waitUntil(
    self.registration.showNotification(data.title, options)
  );
});

self.addEventListener('notificationclick', function(event) {
  event.notification.close();
  event.waitUntil(
    clients.openWindow('/')
  );
});
```

---

## Push Notification Triggers

Notifications are sent when:

1. **Trip shared with user**
   - "Trip Shared: [User] shared [Trip Name] with you"

2. **Trip data modified**
   - "Trip Updated: Changes made to [Trip Name]"

3. **Comment added**
   - "New Comment: [User] commented on [Item]"

4. **Decision made**
   - "Decision Made: [Decision Title] has been decided"

---

## Database Schema

### push_subscriptions

```sql
CREATE TABLE push_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  endpoint TEXT NOT NULL UNIQUE,
  p256dh TEXT NOT NULL,
  auth TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_push_subs_user ON push_subscriptions(user_id);
```

---

## Installation Prompt

### Detecting Installation

```typescript
// hooks/usePWA.ts
export function usePWA() {
  const [installPrompt, setInstallPrompt] = useState<any>(null);
  const [isInstalled, setIsInstalled] = useState(false);

  useEffect(() => {
    // Check if already installed
    if (window.matchMedia('(display-mode: standalone)').matches) {
      setIsInstalled(true);
      return;
    }

    // Listen for install prompt
    const handleBeforeInstall = (e: Event) => {
      e.preventDefault();
      setInstallPrompt(e);
    };

    window.addEventListener('beforeinstallprompt', handleBeforeInstall);

    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstall);
    };
  }, []);

  const install = async () => {
    if (!installPrompt) return;

    installPrompt.prompt();
    const { outcome } = await installPrompt.userChoice;

    if (outcome === 'accepted') {
      setIsInstalled(true);
    }
    setInstallPrompt(null);
  };

  return { installPrompt, isInstalled, install };
}
```

### Install Banner

```tsx
function InstallBanner() {
  const { installPrompt, install } = usePWA();

  if (!installPrompt) return null;

  return (
    <div className="fixed bottom-4 left-4 right-4 bg-purple-600 text-white p-4 rounded-lg shadow-lg flex items-center justify-between">
      <div>
        <p className="font-medium">Install Holiday Planner</p>
        <p className="text-sm opacity-90">Add to your home screen for quick access</p>
      </div>
      <button
        onClick={install}
        className="bg-white text-purple-600 px-4 py-2 rounded-lg font-medium"
      >
        Install
      </button>
    </div>
  );
}
```

---

## Meta Tags

### Head Tags (layout.tsx)

```tsx
export const metadata = {
  title: 'Holiday Planner',
  description: 'Plan your family holidays with AI assistance',
  manifest: '/manifest.json',
  themeColor: '#8B5CF6',
  appleWebApp: {
    capable: true,
    statusBarStyle: 'default',
    title: 'Holiday Planner',
  },
  viewport: {
    width: 'device-width',
    initialScale: 1,
    maximumScale: 1,
    userScalable: false,
  },
};
```

### Apple Touch Icons

```html
<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
<link rel="apple-touch-startup-image" href="/icons/splash-2048x2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)">
```

---

## Best Practices

### Performance

- Use `next/image` for optimized images
- Lazy load non-critical components
- Minimize JavaScript bundle size
- Use appropriate cache headers

### Reliability

- Graceful degradation when offline
- Queue actions for sync when back online
- Show clear offline indicators
- Preserve form data locally

### User Experience

- Immediate feedback for all actions
- Smooth animations and transitions
- Clear loading states
- Helpful error messages
